<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SQL Agent Chat</title>
  <!-- React & ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel so we can use JSX directly -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Axios for API calls -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f8;
      margin: 0;
      padding: 20px;
    }
    #chat { width: 600px; margin: 0 auto; }
    #messages {
      height: 400px;
      overflow-y: auto;
      background: #fff;
      padding: 12px;
      border: 1px solid #ddd;
    }
    .msg { margin: 6px 0; }
    .from { font-size: 12px; color: #666; }
    .bubble {
      padding: 8px 12px;
      background: #f1f1f1;
      border-radius: 8px;
      white-space: pre-wrap;
    }
    #inputArea {
      display: flex;
      margin-top: 8px;
    }
    #inputArea input {
      flex: 1;
      padding: 8px;
    }
    #inputArea button {
      margin-left: 8px;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    function Message({ from, text }) {
      return (
        <div className="msg">
          <div className="from">{from}</div>
          <div className="bubble">{text}</div>
        </div>
      );
    }

    function ChatApp() {
      const [messages, setMessages] = useState([]);
      const [value, setValue] = useState("");
      const [loading, setLoading] = useState(false);

      async function onSend() {
        if (!value.trim()) return;
        const q = value.trim();
        setMessages((m) => [...m, { from: "You", text: q }]);
        setValue("");
        setLoading(true);

        try {
          const res = await axios.post("http://localhost:4000/api/chat", { question: q });
          if (res.data.rows) {
            const answer = res.data.answer;
            const text = JSON.stringify(res.data.rows.slice(0, 20), null, 2);
            //setMessages((m) => [...m, { from: "Agent", text }]);
            setMessages((m) => [
              ...m,
              { from: "Agent", text: answer },
              { from: "Agent", text }
            ]);
          } else {
            setMessages((m) => [...m, { from: "Agent", text: res.data.error || "No result" }]);
          }
        } catch (e) {
          setMessages((m) => [...m, { from: "Agent", text: "Error: " + e.message }]);
        } finally {
          setLoading(false);
        }
      }

      return (
        <div id="chat">
          <h2 style={{ textAlign: "center" }}>SQL Agent Chat</h2>
          <div id="messages">
            {messages.map((m, i) => (
              <Message key={i} from={m.from} text={m.text} />
            ))}
          </div>
          <div id="inputArea">
            <input
              value={value}
              placeholder="Ask a question..."
              onChange={(e) => setValue(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && onSend()}
            />
            <button onClick={onSend} disabled={loading}>
              {loading ? "..." : "Send"}
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<ChatApp />);
  </script>
</body>
</html>
